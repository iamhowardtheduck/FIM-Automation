# ═══════════════════════════════════════════════════════════════════════════════
# CMDB → Agent Policy: Windows Server FIM Automation
# ═══════════════════════════════════════════════════════════════════════════════
#
# What this workflow does:
#   1. Queries logs-servicenow.event-default for all CMDB records
#   2. Filters to docs where servicenow.event.support_group.value = "Windows Admin"
#   3. Further filters to Windows Server 2016/2019/2022 OS targets
#   4. Creates (or skips if exists) a Fleet Agent Policy called "Windows-Servers"
#   5. Adds the FIM 1.16.0 integration with Windows Server-specific monitored paths
#
# Trigger: Manual (run from Kibana Workflows UI)
# Requires: FIM package v1.16.0 already installed in Fleet
# ═══════════════════════════════════════════════════════════════════════════════

name: "CMDB → Windows Agent Policy with FIM"
description: >
  Reads CMDB records from logs-servicenow.event-default, identifies Windows Admin
  hosts running Windows Server 2016/2019/2022, creates a Fleet Agent Policy called
  Windows-Servers, and attaches the FIM 1.16.0 integration with server-critical paths.
enabled: true
tags:
  - fim-workshop
  - fleet
  - cmdb
  - windows

# ── Constants ──────────────────────────────────────────────────────────────────
consts:
  cmdbIndex: "logs-servicenow.event-default"
  targetSupportGroup: "Windows Admin"
  policyName: "Windows-Servers"
  policyDescription: "Windows Servers — auto-provisioned by CMDB FIM Workflow"
  policyNamespace: "default"
  fimVersion: "1.16.0"

  # FIM paths for Windows Server (DC, SYSVOL, Group Policy, Tasks, Logs, WMI)
  fimPaths:
    - 'C:\Windows\NTDS\ntds.dit'
    - 'C:\Windows\SYSVOL\'
    - 'C:\Windows\SYSVOL\domain\Policies\'
    - 'C:\Windows\System32\Tasks\'
    - 'C:\Windows\Tasks\'
    - 'C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup'
    - 'C:\Users\*\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup'
    - 'C:\Windows\System32\GroupPolicy\'
    - 'C:\Windows\System32\winevt\Logs\'
    - 'C:\Windows\System32\wbem\'
    - 'C:\Windows\System32\spool\drivers\'

  # Target OS versions (Windows Server only)
  targetOS:
    - "Windows Server 2022"
    - "Windows Server 2019"
    - "Windows Server 2016"

# ── Trigger ────────────────────────────────────────────────────────────────────
triggers:
  - type: manual


# ── Steps ─────────────────────────────────────────────────────────────────────
steps:

  # ── Step 1: Query CMDB for Windows Admin hosts ─────────────────────────────
  - name: query_cmdb_windows
    type: elasticsearch.search
    with:
      index: "{{ consts.cmdbIndex }}"
      size: 1000
      query:
        bool:
          must:
            - term:
                servicenow.event.support_group.value:
                  value: "{{ consts.targetSupportGroup }}"
            - terms:
                servicenow.event.os.value:
                  - "Windows Server 2022"
                  - "Windows Server 2019"
                  - "Windows Server 2016"

  # ── Step 2: Log what we found ──────────────────────────────────────────────
  - name: log_cmdb_results
    type: console
    with:
      message: >
        CMDB query complete.
        Found {{ steps.query_cmdb_windows.output.hits.total.value }} Windows Admin
        hosts running Windows Server 2016/2019/2022.
        Proceeding to check for existing Agent Policy: {{ consts.policyName }}

  # ── Step 3: Check if the policy already exists ─────────────────────────────
  - name: check_policy_exists
    type: http
    with:
      method: GET
      url: "http://elastic-rocks:splunk-sucks@kubernetes-vm:30002/api/fleet/agent_policies?kuery=name:%22Windows-Servers%22"
      headers:
        kbn-xsrf: "true"

  # ── Step 4: Only create policy + FIM if it doesn't already exist ──────────
  - name: policy_create_branch
    type: if
    condition: "steps.check_policy_exists.output.data.total: 0"
    steps:

      # ── Step 4a: Create the Windows-Servers Agent Policy ──────────────────
      - name: create_agent_policy
        type: http
        with:
          method: POST
          url: "http://elastic-rocks:splunk-sucks@kubernetes-vm:30002/api/fleet/agent_policies"
          headers:
            kbn-xsrf: "true"
            Content-Type: "application/json"
          body:
            name: "{{ consts.policyName }}"
            description: "{{ consts.policyDescription }}"
            namespace: "{{ consts.policyNamespace }}"
            monitoring_enabled:
              - logs
              - metrics
              - traces
            inactivity_timeout: 1209600
            is_protected: false
            global_data_tags:
              - name: "windows.author"
                value: "Theodore-Flufferkins"
              - name: "windows.group"
                value: "windows-server-admins"

      # ── Step 4b: Log the new policy ID ────────────────────────────────────
      - name: log_policy_created
        type: console
        with:
          message: >
            Agent Policy created.
            ID: {{ steps.create_agent_policy.output.data.item.id }}
            Name: {{ steps.create_agent_policy.output.data.item.name }}

      # ── Step 4c: Add FIM integration to the new policy ────────────────────
      - name: add_fim_integration
        type: http
        with:
          method: POST
          url: "http://elastic-rocks:splunk-sucks@kubernetes-vm:30002/api/fleet/package_policies"
          headers:
            kbn-xsrf: "true"
            Content-Type: "application/json"
          body:
            force: true
            name: "fim-windows-servers"
            description: "FIM monitoring for Windows Server critical paths"
            namespace: "{{ consts.policyNamespace }}"
            policy_id: "{{ steps.create_agent_policy.output.data.item.id }}"
            policy_ids:
              - "{{ steps.create_agent_policy.output.data.item.id }}"
            enabled: true
            package:
              name: "fim"
              version: "{{ consts.fimVersion }}"
            inputs:
              - type: "audit/file_integrity"
                policy_template: "fim"
                enabled: true
                streams:
                  - enabled: true
                    data_stream:
                      type: logs
                      dataset: fim.event
                    vars:
                      paths:
                        value:
                          - 'C:\Windows\NTDS\ntds.dit'
                          - 'C:\Windows\SYSVOL\'
                          - 'C:\Windows\SYSVOL\domain\Policies\'
                          - 'C:\Windows\System32\Tasks\'
                          - 'C:\Windows\Tasks\'
                          - 'C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup'
                          - 'C:\Users\*\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup'
                          - 'C:\Windows\System32\GroupPolicy\'
                          - 'C:\Windows\System32\winevt\Logs\'
                          - 'C:\Windows\System32\wbem\'
                          - 'C:\Windows\System32\spool\drivers\'
                        type: text
                      recursive:
                        value: false
                        type: bool
                      scan_at_start:
                        value: true
                        type: bool
                      backend:
                        value: "auto"
                        type: text
                      hash_types:
                        value:
                          - sha1
                        type: text
                      max_file_size:
                        value: "100 MiB"
                        type: text
                      scan_rate_per_sec:
                        value: "50 MiB"
                        type: text
                      exclude_files:
                        value:
                          - '(?i)\.sw[nop]$'
                          - '~$'
                          - '/\.git($|/)'
                          - '\.tmp$'
                          - '\.log$'
                          - '\.db$'
                        type: text
                      keep_null:
                        value: false
                        type: bool
                      tags:
                        value:
                          - fim-event
                          - windows-server
                        type: text

      # ── Step 4d: Done ─────────────────────────────────────────────────────
      - name: log_complete
        type: console
        with:
          message: >
            Workflow complete.
            Policy "{{ consts.policyName }}" ID: {{ steps.create_agent_policy.output.data.item.id }}
            FIM package policy ID: {{ steps.add_fim_integration.output.data.item.id }}
            CMDB Windows Admin hosts found: {{ steps.query_cmdb_windows.output.hits.total.value }}

    else:
      # ── Policy already exists — skip creation ──────────────────────────────
      - name: log_policy_exists
        type: console
        with:
          message: >
            Policy "{{ consts.policyName }}" already exists
            (total found: {{ steps.check_policy_exists.output.data.total }}).
            Skipping creation. Delete the existing policy to re-provision.
            CMDB Windows Admin hosts found: {{ steps.query_cmdb_windows.output.hits.total.value }}
